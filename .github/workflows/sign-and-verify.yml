name: Build, Sign, Attest Binary

on:
  workflow_dispatch:

jobs:
  build-sign-attest:
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # Required for Sigstore keyless signing
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build binary artifact
        run: |
          echo "Hello world" > myapp.txt
          tar -czf myapp.tar.gz myapp.txt

      - name: Upload artifact to OCI registry
        run: |
          REPO="ghcr.io/${{ github.repository }}/myapp"
          TAG="latest"
          cosign upload blob --repo $REPO --tag $TAG myapp.tar.gz
          echo "IMAGE=$REPO:$TAG" >> $GITHUB_ENV

      - name: Sign artifact with Cosign (keyless)
        run: |
          ./cosign sign --yes $IMAGE:latest

      - name: Create predicate file
        run: |
          cat <<EOF > predicate.json
          {
            "builder": "${{ github.actor }}",
            "buildType": "github-actions",
            "commit": "${{ github.sha }}"
          }
          EOF

      - name: Generate and upload attestation (keyless)
        run: |
          ./cosign attest --yes \
            --type custom \
            --predicate predicate.json
